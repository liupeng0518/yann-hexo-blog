<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















  

<link href="https://lib.baomitu.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.1.0">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'SLJ0R87CAH',
      apiKey: 'fd4f2896d73497ea343ec5d504a06bb4',
      indexName: 'yann_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Zuul2Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于Netty有一篇宏观性的博文有兴趣的可以阅读 Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems 此篇博客。 简而言之，Zuul2也就是从传统的 BIO 切换到了 NIO 模式。传统的BIO模型">
<meta property="og:type" content="article">
<meta property="og:title" content="Zuul2源码分析">
<meta property="og:url" content="http://blog.yannxia.top/2018/06/22/java/microservice/gateway/zuul2/index.html">
<meta property="og:site_name" content="Yann&#39;s Blog">
<meta property="og:description" content="Zuul2Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于Netty有一篇宏观性的博文有兴趣的可以阅读 Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems 此篇博客。 简而言之，Zuul2也就是从传统的 BIO 切换到了 NIO 模式。传统的BIO模型">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PSzIQs.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PSzHe0.png">
<meta property="og:image" content="https://s1.ax1x.com/2018/06/22/PpSZSH.png">
<meta property="og:updated_time" content="2018-06-22T10:08:33.572Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zuul2源码分析">
<meta name="twitter:description" content="Zuul2Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于Netty有一篇宏观性的博文有兴趣的可以阅读 Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems 此篇博客。 简而言之，Zuul2也就是从传统的 BIO 切换到了 NIO 模式。传统的BIO模型">
<meta name="twitter:image" content="https://s1.ax1x.com/2018/06/22/PSzIQs.png">






  <link rel="canonical" href="http://blog.yannxia.top/2018/06/22/java/microservice/gateway/zuul2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Zuul2源码分析 | Yann's Blog</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2b9a42875b7d709260d7a35c174566ba";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yann's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-百科">
    <a href="http://wiki.yannxia.top" rel="section">
      <i class="menu-item-icon fa fa-fw fa-wikipedia-w"></i> <br />百科</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-计划">
    <a href="/plan/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-paper-plane"></i> <br />计划</a>
</li>

      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.yannxia.top/2018/06/22/java/microservice/gateway/zuul2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yann.xia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Logo-2018.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yann's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Zuul2源码分析</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-22T10:49:48+08:00">2018-06-22</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/微服务/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/微服务/网关/" itemprop="url" rel="index"><span itemprop="name">网关</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/22/java/microservice/gateway/zuul2/" class="leancloud_visitors" data-flag-title="Zuul2源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Zuul2"><a href="#Zuul2" class="headerlink" title="Zuul2"></a>Zuul2</h1><p>Zuul2的难产，终于在 2018.4.13 上架了中心仓库，也代表着Zuul正式加入Netty全家桶的怀抱，关于Netty有一篇宏观性的博文有兴趣的可以阅读 <a href="https://medium.com/netflix-techblog/zuul-2-the-netflix-journey-to-asynchronous-non-blocking-systems-45947377fb5c" target="_blank" rel="noopener">Zuul 2 : The Netflix Journey to Asynchronous, Non-Blocking Systems</a> 此篇博客。</p>
<p>简而言之，Zuul2也就是从传统的 BIO 切换到了 NIO 模式。<br><img src="https://s1.ax1x.com/2018/06/22/PSzIQs.png" alt="bio-thread"><br>传统的BIO模型基于Thread的方式</p>
<p><img src="https://s1.ax1x.com/2018/06/22/PSzHe0.png" alt="nio-thread"><br>NIO模型基于Reactor模型</p>
<h2 id="Zuul2-架构"><a href="#Zuul2-架构" class="headerlink" title="Zuul2 架构"></a>Zuul2 架构</h2><p>从上帝视角来开，Zuul2是一个在 <code>Netty</code> 上运行一系列Filter的服务，执行完成PreFilter (inbound filters)之后将请求通过 <code>Netty Client</code> 转发出去，然后将请求的结果通过一系列PostFilter (outbound filters) 返回，如下图所示。<br><img src="https://s1.ax1x.com/2018/06/22/PpSZSH.png" alt="Architectural-over"></p>
<p>正如之前的 <code>ZuulFilter</code> 分为了 <code>Pre</code>,<code>Post</code>,<code>Route</code>,<code>Error</code>，Zuul2的Filter分为三种类型</p>
<ul>
<li>Inbound Filters: 在路由之前执行</li>
<li>Endpoint Filters: 路由操作</li>
<li>Outbound Filters: 得到相应数据之后执行</li>
</ul>
<p>我们用官方的Demo进行分析 <a href="https://github.com/Netflix/zuul/tree/2.1/zuul-sample" target="_blank" rel="noopener">zuul-sample</a>，诸位看官自行下载导入。</p>
<h2 id="ServerStartup"><a href="#ServerStartup" class="headerlink" title="ServerStartup"></a>ServerStartup</h2><p>在Demo的启动中，我们发现启动的入口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ConfigurationManager.loadCascadedPropertiesFromResources(<span class="string">"application"</span>); ➊</span><br><span class="line">    Injector injector = InjectorBuilder.fromModule(<span class="keyword">new</span> ZuulSampleModule()).createInjector(); ➋</span><br><span class="line">    BaseServerStartup serverStartup = injector.getInstance(BaseServerStartup.class);</span><br><span class="line">    server = serverStartup.server(); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startupDuration = System.currentTimeMillis() - startTime;</span><br><span class="line">    System.out.println(<span class="string">"Zuul Sample: finished startup. Duration = "</span> + startupDuration + <span class="string">" ms"</span>);</span><br><span class="line"></span><br><span class="line">    server.start(<span class="keyword">true</span>); ➌</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>➊ 获得系统的一些配置参数<br>➋ Demo中使用的是Google的Guice进行依赖注入的，这个就展开了有兴趣的可以自行去搜索<br>➌ 启动一个Zuul2服务</p>
<p>我们从这个 <code>start()</code> 作为我们的突破口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> sync)</span></span>&#123;</span><br><span class="line">    serverGroup = <span class="keyword">new</span> ServerGroup(<span class="string">"Salamander"</span>, eventLoopConfig.acceptorCount(),   eventLoopConfig.eventLoopCount(), eventLoopGroupMetrics); ➊</span><br><span class="line">    serverGroup.initializeTransport();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;ChannelFuture&gt; allBindFutures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// Setup each of the channel initializers on requested ports.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, ChannelInitializer&gt; entry : portsToChannelInitializers.entrySet())</span><br><span class="line">        &#123;</span><br><span class="line">            allBindFutures.add(setupServerBootstrap(entry.getKey(), entry.getValue())); ➋</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Once all server bootstraps are successfully initialized, then bind to each port.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 构建一个新的 <code>ServerGroup</code><br>➋ <code>setupServerBootstrap()</code> 初始化一个 <code>ServerBootstrap</code>，根据之前Netty的分析，我们知道Netty需要使用 <code>ServerBootstrap</code> 进行 端口绑定，那这里是不是就是那个东西。<br>我们继续深入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">setupServerBootstrap</span><span class="params">(<span class="keyword">int</span> port, ChannelInitializer channelInitializer)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">    ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().group(</span><br><span class="line">            serverGroup.clientToProxyBossPool,</span><br><span class="line">            serverGroup.clientToProxyWorkerPool); ➊</span><br><span class="line"></span><br><span class="line">    serverBootstrap.childHandler(channelInitializer); ➋</span><br><span class="line">    serverBootstrap.validate();</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Binding to port: "</span> + port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flag status as UP just before binding to the port.</span></span><br><span class="line">    serverStatusManager.localStatus(InstanceInfo.InstanceStatus.UP); ➌</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind and start to accept incoming connections.</span></span><br><span class="line">    <span class="keyword">return</span> serverBootstrap.bind(port).sync();  ➍</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ➊ 构建了一个 <code>ServerBootstrap</code> 这个正是Netty的启动类<br>➋ 正如Netty的启动中的处理数据的 <code>Handler</code> 那这里应该也就是Zuul处理的核心所在<br>➌ 一个我们的老朋友，和Eureka集成时改变服务器状态<br>➍ 绑定 <code>ServerNioSockertChannel</code> 不再多做分析</p>
<h2 id="1-3-休息"><a href="#1-3-休息" class="headerlink" title="1/3 休息"></a>1/3 休息</h2><p>我们已经发现了Zuul2是如何启动一个Netty服务的，我们解决了图中红框部分的原理，那我们接下来去了解最为重要的这些Filter是如何工作的，我们上启动中已经发现一个很重要的对象 <code>channelInitializer</code> 我们知道在Netty中，是将一系列的 <code>Handler</code> 聚合在一起并使用 <code>Pipeline</code> 执行（参考<a href="http://blog.yannxia.top/2018/06/20/java/netty/netty-3-pipeline/">Netty源码分析-(3)-ChannelPipeline</a>）我们可以猜测 zuul 的做法是类型，我们从这个 <code>channelInitializer</code> 入手去研究。</p>
<h2 id="ZuulServerChannelInitializer"><a href="#ZuulServerChannelInitializer" class="headerlink" title="ZuulServerChannelInitializer"></a>ZuulServerChannelInitializer</h2><p>我们轻而易举的可以发现 <code>ChannelInitializer</code> 其实是  <code>ZuulServerChannelInitializer</code> 对象。在initChannel中我们发现了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">    storeChannel(ch);</span><br><span class="line">    addTimeoutHandlers(pipeline);</span><br><span class="line">    addPassportHandler(pipeline);</span><br><span class="line">    addTcpRelatedHandlers(pipeline);</span><br><span class="line">    addHttp1Handlers(pipeline);</span><br><span class="line">    addHttpRelatedHandlers(pipeline);</span><br><span class="line">    addZuulHandlers(pipeline); ➊</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在➊前面的都比较简单都是一些标准的 <code>Handler</code> 大家可以自己阅读，最为重要是 <code>addZuulHandlers(pipeline);</code> 这个函数，我们继续深入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addZuulHandlers</span><span class="params">(<span class="keyword">final</span> ChannelPipeline pipeline)</span></span>&#123;</span><br><span class="line">    pipeline.addLast(<span class="string">"logger"</span>, nettyLogger);</span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> ClientRequestReceiver(sessionContextDecorator));</span><br><span class="line">    pipeline.addLast(passportLoggingHandler);</span><br><span class="line">    addZuulFilterChainHandler(pipeline); ➋</span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> ClientResponseWriter(requestCompleteHandler, registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的都很容易看出来，是日志，Session之类的Handler，最为重要的是 ➋ 处增加 ZuulFilter。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addZuulFilterChainHandler</span><span class="params">(<span class="keyword">final</span> ChannelPipeline pipeline)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ZuulFilter&lt;HttpResponseMessage, HttpResponseMessage&gt;[] responseFilters = getFilters(</span><br><span class="line">            <span class="keyword">new</span> OutboundPassportStampingFilter(FILTERS_OUTBOUND_START),</span><br><span class="line">            <span class="keyword">new</span> OutboundPassportStampingFilter(FILTERS_OUTBOUND_END)); ➊</span><br><span class="line"></span><br><span class="line">    <span class="comment">// response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> ZuulFilterChainRunner&lt;HttpResponseMessage&gt; responseFilterChain = getFilterChainRunner(responseFilters,</span><br><span class="line">            filterUsageNotifier); ➋</span><br><span class="line"></span><br><span class="line">    <span class="comment">// endpoint | response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> FilterRunner&lt;HttpRequestMessage, HttpResponseMessage&gt; endPoint = getEndpointRunner(responseFilterChain,</span><br><span class="line">            filterUsageNotifier, filterLoader); ➌</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ZuulFilter&lt;HttpRequestMessage, HttpRequestMessage&gt;[] requestFilters = getFilters(</span><br><span class="line">            <span class="keyword">new</span> InboundPassportStampingFilter(FILTERS_INBOUND_START),</span><br><span class="line">            <span class="keyword">new</span> InboundPassportStampingFilter(FILTERS_INBOUND_END));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request filter chain | end point | response filter chain</span></span><br><span class="line">    <span class="keyword">final</span> ZuulFilterChainRunner&lt;HttpRequestMessage&gt; requestFilterChain = getFilterChainRunner(requestFilters,</span><br><span class="line">            filterUsageNotifier, endPoint);</span><br><span class="line"></span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> ZuulFilterChainHandler(requestFilterChain, responseFilterChain));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 ➊ 深入可以看到 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends ZuulMessage&gt; ZuulFilter&lt;T, T&gt; [] getFilters(<span class="keyword">final</span> ZuulFilter start, <span class="keyword">final</span> ZuulFilter stop) &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ZuulFilter&gt; zuulFilters = filterLoader.getFiltersByType(start.filterType());</span><br><span class="line">    <span class="keyword">final</span> ZuulFilter[] filters = <span class="keyword">new</span> ZuulFilter[zuulFilters.size() + <span class="number">2</span>];</span><br><span class="line">    filters[<span class="number">0</span>] = start;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>, j=<span class="number">0</span>; i &lt; filters.length &amp;&amp; j &lt; zuulFilters.size(); i++,j++) &#123;</span><br><span class="line">        filters[i] = zuulFilters.get(j);</span><br><span class="line">    &#125;</span><br><span class="line">    filters[filters.length -<span class="number">1</span>] = stop;</span><br><span class="line">    <span class="keyword">return</span> filters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里返回了一个 <code>ZuulFilter</code> 的数组，开始分别是 <code>start</code> 和 <code>stop</code> 对应的刚好是 <code>OutboundPassportStampingFilter</code>。</p>
<p>然我们继续回到 <code>addZuulFilterChainHandler()</code> 函数上来，我们发现有三段相似的代码正好对应着获得了 <code>InBound</code><br> <code>OutBond</code> <code>EndPoint</code> 这三种Filter，在代码我们可以看出顺序是</p>
<ol>
<li><code>requestFilters</code> 和 <code>endPointFilters</code> 合并成 <code>requestFilterChain</code></li>
<li><code>responseFilters</code> 构建成 <code>responseFilterChain</code></li>
<li><code>requestFilterChain</code> 和 <code>responseFilterChain</code> 组合成 <code>ZuulFilterChainHandler</code></li>
<li>将 <code>ZuulFilterChainHandler</code> 添加至 <code>pipeline</code> 中</li>
</ol>
<p>那这里我们还有一个疑问，这些Filter是从何而来的？这个答案隐藏在<br><code>com.netflix.zuul.FilterLoader#getFiltersByType</code> 中，通过简单的跟踪我们可以得到<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ZuulFilter&gt; <span class="title">getAllFilters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.filters.values(); ➊</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里 ➊ 获得所有的Fiter，而这里的Filter看起来是通过 <code>Put</code>进来的，通过一个简单的断点，我们就可以发现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.netflix.zuul.FilterFileManager#init</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;    </span><br><span class="line">    filterLoader.putFiltersForClasses(config.getClassNames()); ➊</span><br><span class="line">    manageFiles();</span><br><span class="line">    startPoller();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>➊ 我们通过类的全称限定类名获得的这个Fitler，这个配置是在我们的配置文件中配置的。</p>
<h2 id="2-3-休息"><a href="#2-3-休息" class="headerlink" title="2/3 休息"></a>2/3 休息</h2><p>文至中场，我们已经明白了Zuul2如何将自己的 <code>ZuulFilter</code> 变换成 <code>Netty Handler</code> 并添加到 <code>Netty Pipeline</code> 之中的，那我们还剩下一个问题，这个 <code>ZuulFilter</code> 是如何运作的。但是我们在上段中，我们已经发现了最后是一个 <code>ZuulFilterChainHandler</code> 通过名称我们可以推测出，这是一个 <code>Chain 链</code>，我们继续往下探索吧。</p>
<h2 id="ZuulFilterChainHandler"><a href="#ZuulFilterChainHandler" class="headerlink" title="ZuulFilterChainHandler"></a>ZuulFilterChainHandler</h2><p>我们知道，最终注册到 <code>Netty Pipeline</code> 上的最终肯定是 <code>Handler</code>, 我们只需要从 Netty 的 <code>channelRead()</code> 函数作为突破口去阅读。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> HttpRequestMessage) &#123; ➊</span><br><span class="line">        zuulRequest = (HttpRequestMessage)msg;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Replace NETTY_SERVER_CHANNEL_HANDLER_CONTEXT in SessionContext</span></span><br><span class="line">        <span class="keyword">final</span> SessionContext zuulCtx = zuulRequest.getContext();</span><br><span class="line">        zuulCtx.put(NETTY_SERVER_CHANNEL_HANDLER_CONTEXT, ctx);</span><br><span class="line">        zuulCtx.put(ZUUL_FILTER_CHAIN, requestFilterChain);</span><br><span class="line"></span><br><span class="line">        requestFilterChain.filter(zuulRequest); ➋</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((msg <span class="keyword">instanceof</span> HttpContent)&amp;&amp;(zuulRequest != <span class="keyword">null</span>)) &#123;  ➌</span><br><span class="line">        requestFilterChain.filter(zuulRequest, (HttpContent) msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Received unrecognized message type. "</span> + msg.getClass().getName());</span><br><span class="line">        ReferenceCountUtil.release(msg); ➍</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 这段逻辑处理 已经被转化为 <code>HttpRequestMessage</code> 类型的消息<br>➋ 实际上的 filter 处理逻辑<br>➌ 处理还没被转化为 <code>HttpRequestMessage</code> 类型的消息<br>➍ 无法处理抛出异常，释放MSG</p>
<p>而这里的 <code>requestFilterChain</code> 就是之前我们传入进去的 <code>ZuulFilterChainRunner</code> 我们看看这 <code>filter()</code> 函数做了什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.netflix.zuul.netty.filter.ZuulFilterChainRunner#runFilters </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runFilters</span><span class="params">(<span class="keyword">final</span> T mesg, <span class="keyword">final</span> AtomicInteger runningFilterIdx)</span> </span>&#123;</span><br><span class="line">    T inMesg = mesg;</span><br><span class="line">    String filterName = <span class="string">"-"</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Preconditions.checkNotNull(mesg, <span class="string">"Input message"</span>);</span><br><span class="line">        <span class="keyword">int</span> i = runningFilterIdx.get(); ➊</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; filters.length) &#123;</span><br><span class="line">            <span class="keyword">final</span> ZuulFilter&lt;T, T&gt; filter = filters[i]; ➋</span><br><span class="line">            filterName = filter.filterName();</span><br><span class="line">            <span class="keyword">final</span> T outMesg = filter(filter, inMesg); ➌</span><br><span class="line">            <span class="keyword">if</span> (outMesg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">//either async filter or waiting for the message body to be buffered</span></span><br><span class="line">            &#125;</span><br><span class="line">            inMesg = outMesg;</span><br><span class="line">            i = runningFilterIdx.incrementAndGet(); ➍</span><br><span class="line">        &#125;</span><br><span class="line">        invokeNextStage(inMesg); ➎</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 获得当前运行的Filter的下标值<br>➋ 获得对应的 <code>ZuulFilter</code><br>➌ 调用 <code>ZuulFilter</code> 进行处理<br>➍ 将下标志值 +1，继续循环体<br>➎ 执行下个阶段，这里对应着我们自己再构建 <code>new InboundPassportStampingFilter(FILTERS_INBOUND_END)</code></p>
<p>通过这段代码，我们知道了 <code>Zuul2</code> 的Chain是由 <code>ChainRunner</code>运行，和Netty的Head tail的链方式大相径庭。<br>在 <code>BaseZuulFilterRunner</code> 中的 <code>filter()</code> 函数也相当有趣。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.netflix.zuul.netty.filter.BaseZuulFilterRunner#filter </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> O <span class="title">filter</span><span class="params">(<span class="keyword">final</span> ZuulFilter&lt;I, O&gt; filter, <span class="keyword">final</span> I inMesg)</span> </span>&#123;</span><br><span class="line">  filter.incrementConcurrency();</span><br><span class="line">    resumer = <span class="keyword">new</span> FilterChainResumer(inMesg, filter, snapshot, startTime); ➊</span><br><span class="line">    filter.applyAsync(inMesg) ➋</span><br><span class="line">        .observeOn(Schedulers.from(getChannelHandlerContext(inMesg).executor()))  ➌</span><br><span class="line">        .doOnUnsubscribe(resumer::decrementConcurrency)</span><br><span class="line">        .subscribe(resumer);  ➍</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;  <span class="comment">//wait for the async filter to finish</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>➊ 临时存储起来这个Filter待异步完成回调<br>➋ 具体的执行处<br>➌ 获取当前的所在的 <code>EventExecutor</code> 并在这个线程上观察<br>➍ 将数据在 resumer 中消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(O outMesg)</span> </span>&#123;  ➊</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        recordFilterCompletion(SUCCESS, filter, startTime, inMesg, snapshot);</span><br><span class="line">        <span class="keyword">if</span> (outMesg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            outMesg = filter.getDefaultOutput(inMesg);</span><br><span class="line">        &#125;</span><br><span class="line">        resumeInBindingContext(outMesg, filter.filterName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 处获得我们的结果并将其恢复到我们保管的 <code>filter</code>。</p>
<p>剩余关于 <code>ReponseFilter</code> 的运行机制是类似的，诸位看官自行分析下。</p>
<h2 id="终场休息"><a href="#终场休息" class="headerlink" title="终场休息"></a>终场休息</h2><p>通过上面的一系列分析，我们已经知道的，Zuul的 <code>调用链模型</code>，<code>PreFilters</code>的运行机制，整个Zuul2的运行机制在我们的面前一览无遗。整体的Zuul代码是相当的明了的，代码的分层也很好，但是还有一朵乌云在我们的头顶之上，那就是在那张途中的 <code>Netty Client</code> 我们并没有发现其踪迹，但是我们知道只有在 <code>End</code> 阶段，我们才会对外进行访问，在官网的Wiki中，我们也可以获得</p>
<blockquote>
<p>Zuul does not use Ribbon for making outgoing connections and instead uses its own connection pool, using a Netty client. Zuul creates a connection pool per host, per event loop. It does this in order to reduce context switching between threads and to ensure sanity for both the inbound event loops and outbound event loops. The result is that the entire request is run on the same thread, regardless of which event loop is running it.</p>
</blockquote>
<p>我们从 <code>Wiki</code> 中可以得知，Netty不再默认使用 Ribbon 而是默认使用 <code>Netty</code> 作为一个 <code>Client</code>.</p>
<h2 id="ProxyEndpoint"><a href="#ProxyEndpoint" class="headerlink" title="ProxyEndpoint"></a>ProxyEndpoint</h2><p>这个类的对象及其的复杂，我们从filter的核心逻辑 <code>apply</code>看起来。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">apply</span><span class="params">(<span class="keyword">final</span> HttpRequestMessage input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        origin.getProxyTiming(zuulRequest).start();</span><br><span class="line">        origin.onRequestExecutionStart(zuulRequest, <span class="number">1</span>);</span><br><span class="line">        proxyRequestToOrigin(); ➊</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>➊ 将请求转发至远端<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">proxyRequestToOrigin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Promise&lt;PooledConnection&gt; promise = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        promise = origin.connectToOrigin(zuulRequest, channelCtx.channel().eventLoop(), attemptNum, passport, chosenServer); ➊</span><br><span class="line"></span><br><span class="line">        currentRequestAttempt = origin.newRequestAttempt(chosenServer.get(), context, attemptNum); </span><br><span class="line">        <span class="keyword">if</span> (promise.isDone()) &#123;</span><br><span class="line">            operationComplete(promise); ➋</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            promise.addListener(<span class="keyword">this</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>➊ 处将请求包装，连接到远端地址，获得 Promise<br>➋ 结束的 Promise 处理，在 <code>operationComplete()</code> 中包含了成功的执行代码，至于 <code>connectToOrigin</code> Zuul 包装了 Netty的Client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeClientRequestToOrigin</span><span class="params">(<span class="keyword">final</span> PooledConnection conn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Channel ch = conn.getChannel(); ➊</span><br><span class="line"></span><br><span class="line">    ch.write(zuulRequest);   ➋</span><br><span class="line">    writeBufferedBodyContent(zuulRequest, ch);</span><br><span class="line">    ch.flush(); ➌</span><br><span class="line">    <span class="comment">//Get ready to read origin's response</span></span><br><span class="line">    ch.read(); ➍</span><br><span class="line"></span><br><span class="line">    originConn = conn;</span><br><span class="line">    channelCtx.read(); ➎</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>➊ 获得建立的连接<br>➋ 写入Zuul的请求，也就是用户的请求<br>➌ 将消息Flush出去<br>➍ 在这里读取响应的数据，也就是触发 <code>OutBoundHandler</code> 的处理时间</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Zuul整体逻辑，我们通过博文可以分析而出。</p>
<ol>
<li>ZuulFilter 分为 <code>Inbound</code>, <code>Outbound</code>, <code>EndPoint</code></li>
<li><code>Inbound</code>, <code>Outbound</code>, <code>EndPoint</code> 包裹成 <code>ChainRunner</code></li>
<li><code>ChainRunner</code> 组合成一个 <code>ZuulFilterChainHandler</code>，而 <code>ZuulFilterChainHandler</code> 是Netty的 一个Handler</li>
<li><code>ZuulFilterChainHandler</code> 会组装到 Netty 的 <code>Pipeline</code> 中，剩下来就是Netty的流程了</li>
</ol>
<h2 id="参考知识"><a href="#参考知识" class="headerlink" title="参考知识"></a>参考知识</h2><ul>
<li><a href="https://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="noopener">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="https://segmentfault.com/a/1190000004856071" target="_blank" rel="noopener">谜之RxJava （三）update 2 —— subscribeOn 和 observeOn 的区别</a></li>
<li><a href="https://github.com/Netflix/zuul/wiki" target="_blank" rel="noopener">Zuul-Wiki</a></li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/21/java/netty/netty-5-otherwise/" rel="next" title="Netty源码分析-(5)-其他">
                <i class="fa fa-chevron-left"></i> Netty源码分析-(5)-其他
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2122379" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/Logo-2018.png"
                alt="yann.xia" />
            
              <p class="site-author-name" itemprop="name">yann.xia</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yannxia" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/yann.xia" target="_blank" title="ZhiHu" rel="external nofollow"><i class="fa fa-fw fa-bomb"></i>ZhiHu</a>
                  
                </span>
              
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc/4.0/" class="cc-opacity" target="_blank" rel="external nofollow">
                <img src="/images/cc-by-nc.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                小伙伴の博客
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sakeven.me/" title="Sakeven" target="_blank">Sakeven</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://reficul.io/" title="Reficul" target="_blank">Reficul</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.tomwei7.com/" title="Tomwei" target="_blank">Tomwei</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.jinwei.me" title="Jinwei" target="_blank">Jinwei</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://renlulu.github.io/" title="Renlulu" target="_blank">Renlulu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://justjjy.com/" title="JJY" target="_blank">JJY</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zhyee.top" title="Zhyee" target="_blank">Zhyee</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.ihypo.net" title="Hypo" target="_blank">Hypo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.heytaoge.com/" title="Taoge" target="_blank">Taoge</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Zuul2"><span class="nav-number">1.</span> <span class="nav-text">Zuul2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zuul2-架构"><span class="nav-number">1.1.</span> <span class="nav-text">Zuul2 架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServerStartup"><span class="nav-number">1.2.</span> <span class="nav-text">ServerStartup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-休息"><span class="nav-number">1.3.</span> <span class="nav-text">1/3 休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZuulServerChannelInitializer"><span class="nav-number">1.4.</span> <span class="nav-text">ZuulServerChannelInitializer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-休息"><span class="nav-number">1.5.</span> <span class="nav-text">2/3 休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZuulFilterChainHandler"><span class="nav-number">1.6.</span> <span class="nav-text">ZuulFilterChainHandler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#终场休息"><span class="nav-number">1.7.</span> <span class="nav-text">终场休息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxyEndpoint"><span class="nav-number">1.8.</span> <span class="nav-text">ProxyEndpoint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.9.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考知识"><span class="nav-number">1.10.</span> <span class="nav-text">参考知识</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yann Xia</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="https://lib.baomitu.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://lib.baomitu.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://lib.baomitu.com/velocity/1.2.1/velocity.ui.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  

  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://blog.yannxia.top/2018/06/22/java/microservice/gateway/zuul2/';
        this.page.identifier = '2018/06/22/java/microservice/gateway/zuul2/';
        this.page.title = 'Zuul2源码分析';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://yann-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  





	





  












  




  
  
  
    
  
  <link rel="stylesheet" href="https://lib.baomitu.com/instantsearch.js/1.0.0/instantsearch.min.css">

  
  
    
  
  <script src="https://lib.baomitu.com/instantsearch.js/1.0.0/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=6.1.0"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KPHj3vsvOqeV377r9yw1DdLl-gzGzoHsz", "wGzWlWVU3AFfxa6TgF2BadlD");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

</body>
</html>
